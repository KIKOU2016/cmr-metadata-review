require 'test_helper'

class RecordTest < ActiveSupport::TestCase





  describe "attribute accessor methods" do
    it "returns correct attribute information for a record" do
      record = Record.find_by id: 1
      #had to remove description from yaml, json strings allow characters not allowed in yaml
      assert_equal(record.is_collection?, true)
      assert_equal(record.is_granule?, false)
      assert_equal(record.long_name, "NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS")
      assert_equal(record.short_name, "A2_DySno_NRT")
      assert_equal(record.status_string, "In Process")
      assert_equal(record.concept_id, "C1000000020-LANCEAMSR2")
      assert_equal(record.version_id, "0")
      assert_equal(record.ingested_by, "abaker@element84.com")
    end
  end

  describe "blank_comment_JSON" do
    it "provides correct blank JSON layout from record" do
      record = Record.find_by id: 1
      assert_equal(record.blank_comment_JSON, "{\"ShortName\":\"\",\"VersionId\":\"\",\"InsertTime\":\"\",\"LastUpdate\":\"\",\"LongName\":\"\",\"DataSetId\":\"\",\"Description\":\"\",\"Price\":\"\",\"SpatialKeywords/Keyword\":\"\",\"TemporalKeywords/Keyword\":\"\",\"Temporal/RangeDateTime/BeginningDateTime\":\"\",\"Contacts/Contact/Role\":\"\",\"Contacts/Contact/OrganizationEmails/Email\":\"\",\"ScienceKeywords/ScienceKeyword0/CategoryKeyword\":\"\",\"ScienceKeywords/ScienceKeyword0/TopicKeyword\":\"\",\"ScienceKeywords/ScienceKeyword0/TermKeyword\":\"\",\"ScienceKeywords/ScienceKeyword0/VariableLevel1Keyword/Value\":\"\",\"ScienceKeywords/ScienceKeyword1/CategoryKeyword\":\"\",\"ScienceKeywords/ScienceKeyword1/TopicKeyword\":\"\",\"ScienceKeywords/ScienceKeyword1/TermKeyword\":\"\",\"ScienceKeywords/ScienceKeyword1/VariableLevel1Keyword/Value\":\"\",\"Platforms/Platform/ShortName\":\"\",\"Platforms/Platform/LongName\":\"\",\"Platforms/Platform/Type\":\"\",\"Platforms/Platform/Instruments/Instrument/ShortName\":\"\",\"Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName\":\"\",\"AdditionalAttributes/AdditionalAttribute0/Name\":\"\",\"AdditionalAttributes/AdditionalAttribute0/DataType\":\"\",\"AdditionalAttributes/AdditionalAttribute0/Description\":\"\",\"AdditionalAttributes/AdditionalAttribute0/Value\":\"\",\"AdditionalAttributes/AdditionalAttribute1/Name\":\"\",\"AdditionalAttributes/AdditionalAttribute1/DataType\":\"\",\"AdditionalAttributes/AdditionalAttribute1/Description\":\"\",\"AdditionalAttributes/AdditionalAttribute1/Value\":\"\",\"Campaigns/Campaign/ShortName\":\"\",\"OnlineAccessURLs/OnlineAccessURL/URL\":\"\",\"OnlineAccessURLs/OnlineAccessURL/URLDescription\":null,\"OnlineAccessURLs/OnlineAccessURL/MimeType\":null,\"OnlineResources/OnlineResource0/URL\":\"\",\"OnlineResources/OnlineResource0/Description\":null,\"OnlineResources/OnlineResource0/Type\":\"\",\"OnlineResources/OnlineResource1/URL\":\"\",\"OnlineResources/OnlineResource1/Description\":null,\"OnlineResources/OnlineResource1/Type\":\"\",\"OnlineResources/OnlineResource2/URL\":\"\",\"OnlineResources/OnlineResource2/Description\":null,\"OnlineResources/OnlineResource2/Type\":\"\",\"OnlineResources/OnlineResource3/URL\":\"\",\"OnlineResources/OnlineResource3/Description\":null,\"OnlineResources/OnlineResource3/Type\":\"\",\"OnlineResources/OnlineResource4/URL\":\"\",\"OnlineResources/OnlineResource4/Description\":null,\"OnlineResources/OnlineResource4/Type\":\"\",\"OnlineResources/OnlineResource5/URL\":\"\",\"OnlineResources/OnlineResource5/Description\":null,\"OnlineResources/OnlineResource5/Type\":\"\",\"OnlineResources/OnlineResource6/URL\":\"\",\"OnlineResources/OnlineResource6/Description\":null,\"OnlineResources/OnlineResource6/Type\":\"\",\"AssociatedDIFs/DIF/EntryId\":\"\",\"Spatial/SpatialCoverageType\":\"\",\"Spatial/HorizontalSpatialDomain/Geometry/CoordinateSystem\":\"\",\"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/WestBoundingCoordinate\":\"\",\"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/NorthBoundingCoordinate\":\"\",\"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/EastBoundingCoordinate\":\"\",\"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/SouthBoundingCoordinate\":\"\",\"Spatial/GranuleSpatialRepresentation\":\"\",\"MetadataStandardName\":\"\",\"MetadataStandardVersion\":\"\",\"DatasetId\":\"\",\"DataFormat\":\"\"}")
    end
  end

  describe "script_values && script_score" do 
    it "adds script results and can return them on command" do
      record = Record.find_by id: 1

      #stubbing all requests for raw_data
      stub_request(:get, "https://cmr.earthdata.nasa.gov/search/collections.echo10?concept_id=C1000000020-LANCEAMSR2").with(:headers => {'Accept'=>'*/*', 'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3', 'User-Agent'=>'Ruby'}).to_return(:status => 200, :body => "<?xml version=\"1.0\" encoding=\"UTF-8\"?><results><hits>1</hits><took>14</took><result concept-id=\"C1000000020-LANCEAMSR2\" revision-id=\"8\" format=\"application/echo10+xml\">\n<Collection>\n<ShortName>A2_DySno_NRT</ShortName>\n<VersionId>0</VersionId>\n<InsertTime>2015-05-01T13:26:43Z</InsertTime>\n<LastUpdate>2015-09-14T13:26:43Z</LastUpdate>\n<LongName>NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS</LongName>\n<DataSetId>NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS V0</DataSetId>\n<Description>The Advanced Microwave Scanning Radiometer 2 (AMSR2) instrument on the Global Change Observation Mission - Water 1 (GCOM-W1) provides global passive microwave measurements of terrestrial, oceanic, and atmospheric parameters for the investigation of global water and energy cycles.  Near real-time (NRT) products are generated within 3 hours of the last observations in the file, by the Land Atmosphere Near real-time Capability for EOS (LANCE) at the AMSR Science Investigator-led Processing System (AMSR SIPS), which is collocated with the Global Hydrology Resource Center (GHRC) DAAC.  The GCOM-W1 AMSR2 Level-3 Snow Water Equivalent (SWE) data set contains snow water equivalent (SWE) data and quality assurance flags mapped to Northern and Southern Hemisphere 25 km Equal-Area Scalable Earth Grids (EASE-Grids).  Data are stored in HDF-EOS5 format and are available via HTTP from the EOSDIS LANCE system at https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/.  If data latency is not a primary concern, please consider using science quality products.  Science products are created using the best available ancillary, calibration and ephemeris information.  Science quality products are an internally consistent, well-calibrated record of the Earth's geophysical properties to support science.  The AMSR SIPS plans to start producing initial AMSR2 standard science quality data products in late 2015 and they will be available from the NSIDC DAAC.  Notice: All LANCE AMSR2 data should be used with the understanding that these are preliminary products.  Cross calibration with AMSR-E products has not been performed.  As updates are made to the L1R data set, those changes will be reflected in this higher level product.</Description>\n<CollectionDataType>NEAR_REAL_TIME</CollectionDataType>\n<Orderable>false</Orderable>\n<Visible>true</Visible>\n<ProcessingLevelId>3</ProcessingLevelId>\n<ArchiveCenter>GHRC</ArchiveCenter>\n<CitationForExternalPublication>Tedesco, M., J. Jeyaratnam, and R. Kelly. 2015. NRT AMSR2 Daily L3 Global Snow Water Equivalent EASE-Grids [indicate subset used]. Dataset available online, [https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/] from NASA LANCE AMSR2 at the GHRC DAAC Huntsville, Alabama, U.S.A. doi: http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT</CitationForExternalPublication><Price>0.0</Price><SpatialKeywords>\n<Keyword>GLOBAL</Keyword></SpatialKeywords><TemporalKeywords>\n<Keyword>DAILY</Keyword></TemporalKeywords><Temporal><RangeDateTime>\n<BeginningDateTime>2015-05-01T00:00:00Z</BeginningDateTime></RangeDateTime></Temporal><Contacts><Contact>\n<Role>GHRC USER SERVICES</Role><OrganizationEmails>\n<Email>ghrc-dmg@itsc.uah.edu</Email></OrganizationEmails></Contact></Contacts><ScienceKeywords><ScienceKeyword>\n<CategoryKeyword>EARTH SCIENCE</CategoryKeyword>\n<TopicKeyword>CRYOSPHERE</TopicKeyword>\n<TermKeyword>SNOW/ICE</TermKeyword><VariableLevel1Keyword>\n<Value>SNOW WATER EQUIVALENT</Value></VariableLevel1Keyword></ScienceKeyword><ScienceKeyword>\n<CategoryKeyword>EARTH SCIENCE</CategoryKeyword>\n<TopicKeyword>TERRESTRIAL HYDROSPHERE</TopicKeyword>\n<TermKeyword>SNOW/ICE</TermKeyword><VariableLevel1Keyword>\n<Value>SNOW WATER EQUIVALENT</Value></VariableLevel1Keyword></ScienceKeyword></ScienceKeywords><Platforms><Platform>\n<ShortName>GCOM-W1</ShortName>\n<LongName>GCOM-W1</LongName>\n<Type>SATELLITE</Type><Instruments><Instrument>\n<ShortName>AMSR2</ShortName><Sensors><Sensor>\n<ShortName>AMSR2</ShortName></Sensor></Sensors></Instrument></Instruments></Platform></Platforms>\n<AdditionalAttributes>\n<AdditionalAttribute>\n<Name>identifier_product_doi</Name>\n<DataType>STRING</DataType>\n<Description>product DOI</Description>\n<Value>10.5067/AMSR2/A2_DySno_NRT</Value>\n</AdditionalAttribute>\n<AdditionalAttribute>\n<Name>identifier_product_doi_authority</Name>\n<DataType>STRING</DataType>\n<Description>DOI authority</Description>\n<Value>http://dx.doi.org</Value>\n</AdditionalAttribute>\n</AdditionalAttributes>\n<Campaigns><Campaign>\n<ShortName>LANCE</ShortName></Campaign></Campaigns><OnlineAccessURLs><OnlineAccessURL>\n<URL>https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/</URL><URLDescription></URLDescription><MimeType></MimeType></OnlineAccessURL></OnlineAccessURLs><OnlineResources><OnlineResource>\n<URL>https://lance.itsc.uah.edu/amsr2-science/data/level3/daysnow/R00/hdfeos5/</URL><Description></Description>\n<Type>Alternate Data Access</Type></OnlineResource><OnlineResource>\n<URL>https://lance.nsstc.nasa.gov/amsr2-science/browse_png/level3/daysnow/R00/</URL><Description></Description>\n<Type>Browse</Type></OnlineResource><OnlineResource>\n<URL>https://worldview.earthdata.nasa.gov/</URL><Description></Description>\n<Type>Worldview Imagery</Type></OnlineResource><OnlineResource>\n<URL>http://lance.nsstc.nasa.gov/</URL><Description></Description>\n<Type>Homepage</Type></OnlineResource><OnlineResource>\n<URL>http://lance.nsstc.nasa.gov/amsr2-science/doc/LANCE_A2_DySno_NRT_dataset.pdf</URL><Description></Description>\n<Type>Guide</Type></OnlineResource><OnlineResource>\n<URL>http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT</URL><Description></Description>\n<Type>DOI</Type></OnlineResource><OnlineResource>\n<URL>http://ghrc.nsstc.nasa.gov/uso/citation.html</URL><Description></Description>\n<Type>Citing GHRC Data</Type></OnlineResource></OnlineResources><AssociatedDIFs><DIF>\n<EntryId>A2_DySno_NRT</EntryId></DIF></AssociatedDIFs><Spatial><SpatialCoverageType>Horizontal</SpatialCoverageType><HorizontalSpatialDomain><Geometry>\n<CoordinateSystem>CARTESIAN</CoordinateSystem><BoundingRectangle>\n<WestBoundingCoordinate>-180</WestBoundingCoordinate>\n<NorthBoundingCoordinate>90</NorthBoundingCoordinate>\n<EastBoundingCoordinate>180</EastBoundingCoordinate>\n<SouthBoundingCoordinate>-90</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain>\n<GranuleSpatialRepresentation>CARTESIAN</GranuleSpatialRepresentation></Spatial>\n<MetadataStandardName>ECHO</MetadataStandardName>\n<MetadataStandardVersion>10</MetadataStandardVersion>\n</Collection></result></results>", :headers => {"date"=>["Tue, 21 Feb 2017 16:02:46 GMT"], "content-type"=>["application/echo10+xml; charset=utf-8"], "access-control-expose-headers"=>["CMR-Hits, CMR-Request-Id"], "access-control-allow-origin"=>["*"], "cmr-hits"=>["10554"], "cmr-took"=>["40"], "cmr-request-id"=>["5b0c8426-3a23-4025-a4d3-6d1c9024153a"], "vary"=>["Accept-Encoding, User-Agent"], "connection"=>["close"], "server"=>["Jetty(9.2.z-SNAPSHOT)"]})

      record.create_script
      script_values = record.script_values
      assert_equal(script_values, {"Contacts/Contact/Role"=>"Choose a contact role from the following list: ARCHIVER; DISTRIBUTOR; ORIGINATOR; PROCESSOR;", "CitationForExternalPublication"=>"OK - quality check", "Campaigns/Campaign/ShortName"=>"OK", "OnlineResources/OnlineResource/Type"=>"Invalid types: Alternate Data Access. URL Types are translated to GCMD vocabulary in CMR. In order to avoid translation errors please choose an appropriate URL Content Type from the following keywords list: http://gcmdservices.gsfc.nasa.gov/static/kms/rucontenttype/rucontenttype.csv", "ScienceKeywords/ScienceKeyword/CategoryKeyword"=>"OK - quality check", "Campaigns/Campaign/EndDate"=>"np", "OnlineAccessURLs/OnlineAccessURL/URL"=>"Add a link to directly download the data via URS.", "Orderable"=>"Note: The Orderable field is being deprecated in UMM.", "Platforms/Platform/Instruments/Instrument/ShortName"=>"OK", "RevisionDate"=>"np", "OnlineAccessURLs/OnlineAccessURL/Description"=>"Recommend providing descriptions for all Online Access URLs.", "Platforms/Platform/Type"=>"The platform type does not conform to GCMD", "Description"=>"OK - quality check", "ScienceKeywords/ScienceKeyword/TermKeyword"=>"OK- quality check", "Campaigns/Campaign/LongName"=>"np", "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle"=>"OK - quality check, OK - quality check, OK - quality check, OK - quality check, ", "Platforms/Platform/ShortName"=>"OK", "OnlineResources/OnlineResource/URL"=>"Broken link: http://ghrc.nsstc.nasa.gov/uso/citation.html;", "LongName"=>"Recommend that the Long Name use mixed case to optimize human readability..", "OnlineResources/OnlineResource/Description"=>"Recommend providing descriptions for all Online Resource URLs.", "Platforms/Platform/Instruments/Instrument/LongName"=>"Recommend providing an instrument long name; since many instrument short names are comprised of acronyms.", "ScienceKeywords/ScienceKeyword/VariableLevel1Keyword/Value"=>"OK- quality check", "ProcessingCenter"=>"np", "Temporal/SingleDateTime"=>"np", "ScienceKeywords/ScienceKeyword/TopicKeyword"=>"OK- quality check", "SpatialKeywords/Keyword"=>"OK", "Temporal/SingleDateTime/BeginningDateTime"=>"OK - quality check", "InsertTime"=>"OK - quality check", "Contacts/Contact/OrganizationEmails/Email"=>"Please change from \"ghrc-dmg@itsc.uah.edu\" to \"support-ghrc@earthdata.nasa.gov\" since this is currently listed as the contact email on the GHRC website: https://ghrc.nsstc.nasa.gov/home/contact-us", "ArchiveCenter"=>"It is recommended that the Archive Center name be compliant with GCMD vocabulary. Choose a valid Archive Center name from the following list: http://gcmdservices.gsfc.nasa.gov/static/kms/providers/providers.csv All records from the same DAAC should have the same archive center name for consistency.", "Temporal/RangeDateTime/EndingDateTime"=>"np", "DataSetId"=>"Recommend changing the Dataset Id to mixed case to improve human readability.", "LastUpdate"=>"OK - quality check", "Campaigns/Campaign/StartDate"=>"np", "CollectionState"=>"np", "Platforms/Platform/LongName"=>"Recommend that the Long Name use mixed case to optimize human readability..", "ProcessingLevelId"=>"OK", "ScienceKeywords/ScienceKeyword/VariableLevel1Keyword/VariableLevel2Keyword/Value"=>"np", "ScienceKeywords/ScienceKeyword/VariableLevel1Keyword/VariableLevel2Keyword/VariableLevel3Keyword/Value"=>"np", "Visible"=>"Note: The Visible field is being deprecated in UMM.", "VersionId"=>"OK", "DataFormat"=>"Recommend providing the data format(s) for this dataset.", "ShortName"=>"OK", "OnlineResources/OnlineResource0/Type"=>"Invalid types: Alternate Data Access. URL Types are translated to GCMD vocabulary in CMR. In order to avoid translation errors please choose an appropriate URL Content Type from the following keywords list: http://gcmdservices.gsfc.nasa.gov/static/kms/rucontenttype/rucontenttype.csv", "OnlineResources/OnlineResource1/Type"=>"Invalid types: Alternate Data Access. URL Types are translated to GCMD vocabulary in CMR. In order to avoid translation errors please choose an appropriate URL Content Type from the following keywords list: http://gcmdservices.gsfc.nasa.gov/static/kms/rucontenttype/rucontenttype.csv", "OnlineResources/OnlineResource2/Type"=>"Invalid types: Alternate Data Access. URL Types are translated to GCMD vocabulary in CMR. In order to avoid translation errors please choose an appropriate URL Content Type from the following keywords list: http://gcmdservices.gsfc.nasa.gov/static/kms/rucontenttype/rucontenttype.csv", "OnlineResources/OnlineResource3/Type"=>"Invalid types: Alternate Data Access. URL Types are translated to GCMD vocabulary in CMR. In order to avoid translation errors please choose an appropriate URL Content Type from the following keywords list: http://gcmdservices.gsfc.nasa.gov/static/kms/rucontenttype/rucontenttype.csv", "OnlineResources/OnlineResource4/Type"=>"Invalid types: Alternate Data Access. URL Types are translated to GCMD vocabulary in CMR. In order to avoid translation errors please choose an appropriate URL Content Type from the following keywords list: http://gcmdservices.gsfc.nasa.gov/static/kms/rucontenttype/rucontenttype.csv", "OnlineResources/OnlineResource5/Type"=>"Invalid types: Alternate Data Access. URL Types are translated to GCMD vocabulary in CMR. In order to avoid translation errors please choose an appropriate URL Content Type from the following keywords list: http://gcmdservices.gsfc.nasa.gov/static/kms/rucontenttype/rucontenttype.csv", "OnlineResources/OnlineResource6/Type"=>"Invalid types: Alternate Data Access. URL Types are translated to GCMD vocabulary in CMR. In order to avoid translation errors please choose an appropriate URL Content Type from the following keywords list: http://gcmdservices.gsfc.nasa.gov/static/kms/rucontenttype/rucontenttype.csv", "ScienceKeywords/ScienceKeyword0/CategoryKeyword"=>"OK - quality check", "ScienceKeywords/ScienceKeyword1/CategoryKeyword"=>"OK - quality check", "OnlineAccessURLs/OnlineAccessURL/URLDescription"=>"OK - quality check", "AdditionalAttributes/AdditionalAttribute0/Description"=>"OK - quality check", "AdditionalAttributes/AdditionalAttribute1/Description"=>"OK - quality check", "OnlineResources/OnlineResource0/Description"=>"Recommend providing descriptions for all Online Resource URLs.", "OnlineResources/OnlineResource1/Description"=>"Recommend providing descriptions for all Online Resource URLs.", "OnlineResources/OnlineResource2/Description"=>"Recommend providing descriptions for all Online Resource URLs.", "OnlineResources/OnlineResource3/Description"=>"Recommend providing descriptions for all Online Resource URLs.", "OnlineResources/OnlineResource4/Description"=>"Recommend providing descriptions for all Online Resource URLs.", "OnlineResources/OnlineResource5/Description"=>"Recommend providing descriptions for all Online Resource URLs.", "OnlineResources/OnlineResource6/Description"=>"Recommend providing descriptions for all Online Resource URLs.", "ScienceKeywords/ScienceKeyword0/TermKeyword"=>"OK- quality check", "ScienceKeywords/ScienceKeyword1/TermKeyword"=>"OK- quality check", "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/WestBoundingCoordinate"=>"OK - quality check, OK - quality check, OK - quality check, OK - quality check, ", "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/NorthBoundingCoordinate"=>"OK - quality check, OK - quality check, OK - quality check, OK - quality check, ", "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/EastBoundingCoordinate"=>"OK - quality check, OK - quality check, OK - quality check, OK - quality check, ", "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/SouthBoundingCoordinate"=>"OK - quality check, OK - quality check, OK - quality check, OK - quality check, ", "OnlineResources/OnlineResource0/URL"=>"Broken link: http://ghrc.nsstc.nasa.gov/uso/citation.html;", "OnlineResources/OnlineResource1/URL"=>"Broken link: http://ghrc.nsstc.nasa.gov/uso/citation.html;", "OnlineResources/OnlineResource2/URL"=>"Broken link: http://ghrc.nsstc.nasa.gov/uso/citation.html;", "OnlineResources/OnlineResource3/URL"=>"Broken link: http://ghrc.nsstc.nasa.gov/uso/citation.html;", "OnlineResources/OnlineResource4/URL"=>"Broken link: http://ghrc.nsstc.nasa.gov/uso/citation.html;", "OnlineResources/OnlineResource5/URL"=>"Broken link: http://ghrc.nsstc.nasa.gov/uso/citation.html;", "OnlineResources/OnlineResource6/URL"=>"Broken link: http://ghrc.nsstc.nasa.gov/uso/citation.html;", "ScienceKeywords/ScienceKeyword0/VariableLevel1Keyword/Value"=>"OK- quality check", "ScienceKeywords/ScienceKeyword1/VariableLevel1Keyword/Value"=>"OK- quality check", "ScienceKeywords/ScienceKeyword0/TopicKeyword"=>"OK- quality check", "ScienceKeywords/ScienceKeyword1/TopicKeyword"=>"OK- quality check", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName"=>"OK"})
      assert_equal(record.script_score, 41)
    end
  end

  describe "bubble_map" do
    it "returns correct bubble map" do
      record = Record.find_by id: 1

      #stubbing all requests for raw_data
      stub_request(:get, "https://cmr.earthdata.nasa.gov/search/collections.echo10?concept_id=C1000000020-LANCEAMSR2").with(:headers => {'Accept'=>'*/*', 'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3', 'User-Agent'=>'Ruby'}).to_return(:status => 200, :body => "<?xml version=\"1.0\" encoding=\"UTF-8\"?><results><hits>1</hits><took>14</took><result concept-id=\"C1000000020-LANCEAMSR2\" revision-id=\"8\" format=\"application/echo10+xml\">\n<Collection>\n<ShortName>A2_DySno_NRT</ShortName>\n<VersionId>0</VersionId>\n<InsertTime>2015-05-01T13:26:43Z</InsertTime>\n<LastUpdate>2015-09-14T13:26:43Z</LastUpdate>\n<LongName>NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS</LongName>\n<DataSetId>NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS V0</DataSetId>\n<Description>The Advanced Microwave Scanning Radiometer 2 (AMSR2) instrument on the Global Change Observation Mission - Water 1 (GCOM-W1) provides global passive microwave measurements of terrestrial, oceanic, and atmospheric parameters for the investigation of global water and energy cycles.  Near real-time (NRT) products are generated within 3 hours of the last observations in the file, by the Land Atmosphere Near real-time Capability for EOS (LANCE) at the AMSR Science Investigator-led Processing System (AMSR SIPS), which is collocated with the Global Hydrology Resource Center (GHRC) DAAC.  The GCOM-W1 AMSR2 Level-3 Snow Water Equivalent (SWE) data set contains snow water equivalent (SWE) data and quality assurance flags mapped to Northern and Southern Hemisphere 25 km Equal-Area Scalable Earth Grids (EASE-Grids).  Data are stored in HDF-EOS5 format and are available via HTTP from the EOSDIS LANCE system at https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/.  If data latency is not a primary concern, please consider using science quality products.  Science products are created using the best available ancillary, calibration and ephemeris information.  Science quality products are an internally consistent, well-calibrated record of the Earth's geophysical properties to support science.  The AMSR SIPS plans to start producing initial AMSR2 standard science quality data products in late 2015 and they will be available from the NSIDC DAAC.  Notice: All LANCE AMSR2 data should be used with the understanding that these are preliminary products.  Cross calibration with AMSR-E products has not been performed.  As updates are made to the L1R data set, those changes will be reflected in this higher level product.</Description>\n<CollectionDataType>NEAR_REAL_TIME</CollectionDataType>\n<Orderable>false</Orderable>\n<Visible>true</Visible>\n<ProcessingLevelId>3</ProcessingLevelId>\n<ArchiveCenter>GHRC</ArchiveCenter>\n<CitationForExternalPublication>Tedesco, M., J. Jeyaratnam, and R. Kelly. 2015. NRT AMSR2 Daily L3 Global Snow Water Equivalent EASE-Grids [indicate subset used]. Dataset available online, [https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/] from NASA LANCE AMSR2 at the GHRC DAAC Huntsville, Alabama, U.S.A. doi: http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT</CitationForExternalPublication><Price>0.0</Price><SpatialKeywords>\n<Keyword>GLOBAL</Keyword></SpatialKeywords><TemporalKeywords>\n<Keyword>DAILY</Keyword></TemporalKeywords><Temporal><RangeDateTime>\n<BeginningDateTime>2015-05-01T00:00:00Z</BeginningDateTime></RangeDateTime></Temporal><Contacts><Contact>\n<Role>GHRC USER SERVICES</Role><OrganizationEmails>\n<Email>ghrc-dmg@itsc.uah.edu</Email></OrganizationEmails></Contact></Contacts><ScienceKeywords><ScienceKeyword>\n<CategoryKeyword>EARTH SCIENCE</CategoryKeyword>\n<TopicKeyword>CRYOSPHERE</TopicKeyword>\n<TermKeyword>SNOW/ICE</TermKeyword><VariableLevel1Keyword>\n<Value>SNOW WATER EQUIVALENT</Value></VariableLevel1Keyword></ScienceKeyword><ScienceKeyword>\n<CategoryKeyword>EARTH SCIENCE</CategoryKeyword>\n<TopicKeyword>TERRESTRIAL HYDROSPHERE</TopicKeyword>\n<TermKeyword>SNOW/ICE</TermKeyword><VariableLevel1Keyword>\n<Value>SNOW WATER EQUIVALENT</Value></VariableLevel1Keyword></ScienceKeyword></ScienceKeywords><Platforms><Platform>\n<ShortName>GCOM-W1</ShortName>\n<LongName>GCOM-W1</LongName>\n<Type>SATELLITE</Type><Instruments><Instrument>\n<ShortName>AMSR2</ShortName><Sensors><Sensor>\n<ShortName>AMSR2</ShortName></Sensor></Sensors></Instrument></Instruments></Platform></Platforms>\n<AdditionalAttributes>\n<AdditionalAttribute>\n<Name>identifier_product_doi</Name>\n<DataType>STRING</DataType>\n<Description>product DOI</Description>\n<Value>10.5067/AMSR2/A2_DySno_NRT</Value>\n</AdditionalAttribute>\n<AdditionalAttribute>\n<Name>identifier_product_doi_authority</Name>\n<DataType>STRING</DataType>\n<Description>DOI authority</Description>\n<Value>http://dx.doi.org</Value>\n</AdditionalAttribute>\n</AdditionalAttributes>\n<Campaigns><Campaign>\n<ShortName>LANCE</ShortName></Campaign></Campaigns><OnlineAccessURLs><OnlineAccessURL>\n<URL>https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/</URL><URLDescription></URLDescription><MimeType></MimeType></OnlineAccessURL></OnlineAccessURLs><OnlineResources><OnlineResource>\n<URL>https://lance.itsc.uah.edu/amsr2-science/data/level3/daysnow/R00/hdfeos5/</URL><Description></Description>\n<Type>Alternate Data Access</Type></OnlineResource><OnlineResource>\n<URL>https://lance.nsstc.nasa.gov/amsr2-science/browse_png/level3/daysnow/R00/</URL><Description></Description>\n<Type>Browse</Type></OnlineResource><OnlineResource>\n<URL>https://worldview.earthdata.nasa.gov/</URL><Description></Description>\n<Type>Worldview Imagery</Type></OnlineResource><OnlineResource>\n<URL>http://lance.nsstc.nasa.gov/</URL><Description></Description>\n<Type>Homepage</Type></OnlineResource><OnlineResource>\n<URL>http://lance.nsstc.nasa.gov/amsr2-science/doc/LANCE_A2_DySno_NRT_dataset.pdf</URL><Description></Description>\n<Type>Guide</Type></OnlineResource><OnlineResource>\n<URL>http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT</URL><Description></Description>\n<Type>DOI</Type></OnlineResource><OnlineResource>\n<URL>http://ghrc.nsstc.nasa.gov/uso/citation.html</URL><Description></Description>\n<Type>Citing GHRC Data</Type></OnlineResource></OnlineResources><AssociatedDIFs><DIF>\n<EntryId>A2_DySno_NRT</EntryId></DIF></AssociatedDIFs><Spatial><SpatialCoverageType>Horizontal</SpatialCoverageType><HorizontalSpatialDomain><Geometry>\n<CoordinateSystem>CARTESIAN</CoordinateSystem><BoundingRectangle>\n<WestBoundingCoordinate>-180</WestBoundingCoordinate>\n<NorthBoundingCoordinate>90</NorthBoundingCoordinate>\n<EastBoundingCoordinate>180</EastBoundingCoordinate>\n<SouthBoundingCoordinate>-90</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain>\n<GranuleSpatialRepresentation>CARTESIAN</GranuleSpatialRepresentation></Spatial>\n<MetadataStandardName>ECHO</MetadataStandardName>\n<MetadataStandardVersion>10</MetadataStandardVersion>\n</Collection></result></results>", :headers => {"date"=>["Tue, 21 Feb 2017 16:02:46 GMT"], "content-type"=>["application/echo10+xml; charset=utf-8"], "access-control-expose-headers"=>["CMR-Hits, CMR-Request-Id"], "access-control-allow-origin"=>["*"], "cmr-hits"=>["10554"], "cmr-took"=>["40"], "cmr-request-id"=>["5b0c8426-3a23-4025-a4d3-6d1c9024153a"], "vary"=>["Accept-Encoding, User-Agent"], "connection"=>["close"], "server"=>["Jetty(9.2.z-SNAPSHOT)"]})
      record.create_script
      assert_equal(record.bubble_map, {"ShortName"=>{:field_name=>"ShortName", :color=>"white", :script=>false, :opinion=>false}, "VersionId"=>{:field_name=>"VersionId", :color=>"white", :script=>false, :opinion=>false}, "InsertTime"=>{:field_name=>"InsertTime", :color=>"white", :script=>false, :opinion=>false}, "LastUpdate"=>{:field_name=>"LastUpdate", :color=>"white", :script=>false, :opinion=>false}, "LongName"=>{:field_name=>"LongName", :color=>"white", :script=>true, :opinion=>false}, "DataSetId"=>{:field_name=>"DataSetId", :color=>"white", :script=>true, :opinion=>false}, "Description"=>{:field_name=>"Description", :color=>"white", :script=>false, :opinion=>false}, "Price"=>{:field_name=>"Price", :color=>"white", :script=>nil, :opinion=>false}, "SpatialKeywords/Keyword"=>{:field_name=>"SpatialKeywords/Keyword", :color=>"white", :script=>false, :opinion=>false}, "TemporalKeywords/Keyword"=>{:field_name=>"TemporalKeywords/Keyword", :color=>"white", :script=>nil, :opinion=>false}, "Temporal/RangeDateTime/BeginningDateTime"=>{:field_name=>"Temporal/RangeDateTime/BeginningDateTime", :color=>"white", :script=>nil, :opinion=>false}, "Contacts/Contact/Role"=>{:field_name=>"Contacts/Contact/Role", :color=>"white", :script=>true, :opinion=>false}, "Contacts/Contact/OrganizationEmails/Email"=>{:field_name=>"Contacts/Contact/OrganizationEmails/Email", :color=>"white", :script=>true, :opinion=>false}, "ScienceKeywords/ScienceKeyword0/CategoryKeyword"=>{:field_name=>"ScienceKeywords/ScienceKeyword0/CategoryKeyword", :color=>"white", :script=>false, :opinion=>false}, "ScienceKeywords/ScienceKeyword0/TopicKeyword"=>{:field_name=>"ScienceKeywords/ScienceKeyword0/TopicKeyword", :color=>"white", :script=>false, :opinion=>false}, "ScienceKeywords/ScienceKeyword0/TermKeyword"=>{:field_name=>"ScienceKeywords/ScienceKeyword0/TermKeyword", :color=>"white", :script=>false, :opinion=>false}, "ScienceKeywords/ScienceKeyword0/VariableLevel1Keyword/Value"=>{:field_name=>"ScienceKeywords/ScienceKeyword0/VariableLevel1Keyword/Value", :color=>"white", :script=>false, :opinion=>false}, "ScienceKeywords/ScienceKeyword1/CategoryKeyword"=>{:field_name=>"ScienceKeywords/ScienceKeyword1/CategoryKeyword", :color=>"white", :script=>false, :opinion=>false}, "ScienceKeywords/ScienceKeyword1/TopicKeyword"=>{:field_name=>"ScienceKeywords/ScienceKeyword1/TopicKeyword", :color=>"white", :script=>false, :opinion=>false}, "ScienceKeywords/ScienceKeyword1/TermKeyword"=>{:field_name=>"ScienceKeywords/ScienceKeyword1/TermKeyword", :color=>"white", :script=>false, :opinion=>false}, "ScienceKeywords/ScienceKeyword1/VariableLevel1Keyword/Value"=>{:field_name=>"ScienceKeywords/ScienceKeyword1/VariableLevel1Keyword/Value", :color=>"white", :script=>false, :opinion=>false}, "Platforms/Platform/ShortName"=>{:field_name=>"Platforms/Platform/ShortName", :color=>"white", :script=>false, :opinion=>false}, "Platforms/Platform/LongName"=>{:field_name=>"Platforms/Platform/LongName", :color=>"white", :script=>true, :opinion=>false}, "Platforms/Platform/Type"=>{:field_name=>"Platforms/Platform/Type", :color=>"white", :script=>true, :opinion=>false}, "Platforms/Platform/Instruments/Instrument/ShortName"=>{:field_name=>"Platforms/Platform/Instruments/Instrument/ShortName", :color=>"white", :script=>false, :opinion=>false}, "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName"=>{:field_name=>"Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName", :color=>"white", :script=>false, :opinion=>false}, "AdditionalAttributes/AdditionalAttribute0/Name"=>{:field_name=>"AdditionalAttributes/AdditionalAttribute0/Name", :color=>"white", :script=>nil, :opinion=>false}, "AdditionalAttributes/AdditionalAttribute0/DataType"=>{:field_name=>"AdditionalAttributes/AdditionalAttribute0/DataType", :color=>"white", :script=>nil, :opinion=>false}, "AdditionalAttributes/AdditionalAttribute0/Description"=>{:field_name=>"AdditionalAttributes/AdditionalAttribute0/Description", :color=>"white", :script=>false, :opinion=>false}, "AdditionalAttributes/AdditionalAttribute0/Value"=>{:field_name=>"AdditionalAttributes/AdditionalAttribute0/Value", :color=>"white", :script=>nil, :opinion=>false}, "AdditionalAttributes/AdditionalAttribute1/Name"=>{:field_name=>"AdditionalAttributes/AdditionalAttribute1/Name", :color=>"white", :script=>nil, :opinion=>false}, "AdditionalAttributes/AdditionalAttribute1/DataType"=>{:field_name=>"AdditionalAttributes/AdditionalAttribute1/DataType", :color=>"white", :script=>nil, :opinion=>false}, "AdditionalAttributes/AdditionalAttribute1/Description"=>{:field_name=>"AdditionalAttributes/AdditionalAttribute1/Description", :color=>"white", :script=>false, :opinion=>false}, "AdditionalAttributes/AdditionalAttribute1/Value"=>{:field_name=>"AdditionalAttributes/AdditionalAttribute1/Value", :color=>"white", :script=>nil, :opinion=>false}, "Campaigns/Campaign/ShortName"=>{:field_name=>"Campaigns/Campaign/ShortName", :color=>"white", :script=>false, :opinion=>false}, "OnlineAccessURLs/OnlineAccessURL/URL"=>{:field_name=>"OnlineAccessURLs/OnlineAccessURL/URL", :color=>"white", :script=>true, :opinion=>false}, "OnlineAccessURLs/OnlineAccessURL/URLDescription"=>{:field_name=>"OnlineAccessURLs/OnlineAccessURL/URLDescription", :color=>nil, :script=>false, :opinion=>false}, "OnlineAccessURLs/OnlineAccessURL/MimeType"=>{:field_name=>"OnlineAccessURLs/OnlineAccessURL/MimeType", :color=>nil, :script=>nil, :opinion=>false}, "OnlineResources/OnlineResource0/URL"=>{:field_name=>"OnlineResources/OnlineResource0/URL", :color=>"white", :script=>false, :opinion=>false}, "OnlineResources/OnlineResource0/Description"=>{:field_name=>"OnlineResources/OnlineResource0/Description", :color=>nil, :script=>true, :opinion=>false}, "OnlineResources/OnlineResource0/Type"=>{:field_name=>"OnlineResources/OnlineResource0/Type", :color=>"white", :script=>true, :opinion=>false}, "OnlineResources/OnlineResource1/URL"=>{:field_name=>"OnlineResources/OnlineResource1/URL", :color=>"white", :script=>false, :opinion=>false}, "OnlineResources/OnlineResource1/Description"=>{:field_name=>"OnlineResources/OnlineResource1/Description", :color=>nil, :script=>true, :opinion=>false}, "OnlineResources/OnlineResource1/Type"=>{:field_name=>"OnlineResources/OnlineResource1/Type", :color=>"white", :script=>true, :opinion=>false}, "OnlineResources/OnlineResource2/URL"=>{:field_name=>"OnlineResources/OnlineResource2/URL", :color=>"white", :script=>false, :opinion=>false}, "OnlineResources/OnlineResource2/Description"=>{:field_name=>"OnlineResources/OnlineResource2/Description", :color=>nil, :script=>true, :opinion=>false}, "OnlineResources/OnlineResource2/Type"=>{:field_name=>"OnlineResources/OnlineResource2/Type", :color=>"white", :script=>true, :opinion=>false}, "OnlineResources/OnlineResource3/URL"=>{:field_name=>"OnlineResources/OnlineResource3/URL", :color=>"white", :script=>false, :opinion=>false}, "OnlineResources/OnlineResource3/Description"=>{:field_name=>"OnlineResources/OnlineResource3/Description", :color=>nil, :script=>true, :opinion=>false}, "OnlineResources/OnlineResource3/Type"=>{:field_name=>"OnlineResources/OnlineResource3/Type", :color=>"white", :script=>true, :opinion=>false}, "OnlineResources/OnlineResource4/URL"=>{:field_name=>"OnlineResources/OnlineResource4/URL", :color=>"white", :script=>false, :opinion=>false}, "OnlineResources/OnlineResource4/Description"=>{:field_name=>"OnlineResources/OnlineResource4/Description", :color=>nil, :script=>true, :opinion=>false}, "OnlineResources/OnlineResource4/Type"=>{:field_name=>"OnlineResources/OnlineResource4/Type", :color=>"white", :script=>true, :opinion=>false}, "OnlineResources/OnlineResource5/URL"=>{:field_name=>"OnlineResources/OnlineResource5/URL", :color=>"white", :script=>false, :opinion=>false}, "OnlineResources/OnlineResource5/Description"=>{:field_name=>"OnlineResources/OnlineResource5/Description", :color=>nil, :script=>true, :opinion=>false}, "OnlineResources/OnlineResource5/Type"=>{:field_name=>"OnlineResources/OnlineResource5/Type", :color=>"white", :script=>true, :opinion=>false}, "OnlineResources/OnlineResource6/URL"=>{:field_name=>"OnlineResources/OnlineResource6/URL", :color=>"white", :script=>false, :opinion=>false}, "OnlineResources/OnlineResource6/Description"=>{:field_name=>"OnlineResources/OnlineResource6/Description", :color=>nil, :script=>true, :opinion=>false}, "OnlineResources/OnlineResource6/Type"=>{:field_name=>"OnlineResources/OnlineResource6/Type", :color=>"white", :script=>true, :opinion=>false}, "AssociatedDIFs/DIF/EntryId"=>{:field_name=>"AssociatedDIFs/DIF/EntryId", :color=>"white", :script=>nil, :opinion=>false}, "Spatial/SpatialCoverageType"=>{:field_name=>"Spatial/SpatialCoverageType", :color=>"white", :script=>nil, :opinion=>false}, "Spatial/HorizontalSpatialDomain/Geometry/CoordinateSystem"=>{:field_name=>"Spatial/HorizontalSpatialDomain/Geometry/CoordinateSystem", :color=>"white", :script=>nil, :opinion=>false}, "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/WestBoundingCoordinate"=>{:field_name=>"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/WestBoundingCoordinate", :color=>"white", :script=>false, :opinion=>false}, "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/NorthBoundingCoordinate"=>{:field_name=>"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/NorthBoundingCoordinate", :color=>"white", :script=>false, :opinion=>false}, "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/EastBoundingCoordinate"=>{:field_name=>"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/EastBoundingCoordinate", :color=>"white", :script=>false, :opinion=>false}, "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/SouthBoundingCoordinate"=>{:field_name=>"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/SouthBoundingCoordinate", :color=>"white", :script=>false, :opinion=>false}, "Spatial/GranuleSpatialRepresentation"=>{:field_name=>"Spatial/GranuleSpatialRepresentation", :color=>"white", :script=>nil, :opinion=>false}, "MetadataStandardName"=>{:field_name=>"MetadataStandardName", :color=>"white", :script=>nil, :opinion=>false}, "MetadataStandardVersion"=>{:field_name=>"MetadataStandardVersion", :color=>"white", :script=>nil, :opinion=>false}, "DatasetId"=>{:field_name=>"DatasetId", :color=>"white", :script=>nil, :opinion=>false}, "DataFormat"=>{:field_name=>"DataFormat", :color=>"white", :script=>true, :opinion=>false}})
    end
  end

  describe "color_coding_complete? && has_enough_reviews" do
    it "catches incomplete record reviews" do
      record = Record.find_by id: 1
      assert_equal(record.color_coding_complete?, false)
      assert_equal(record.has_enough_reviews?, false)

      #testing again with only one color missing
      color_codes = record.get_colors.values
      color_codes.each_with_index do |(key, value), indexer|
        if indexer == 0
          color_codes[key] = "white"
        else
          color_codes[key] = "green"
        end
      end
      record.get_colors.update_values(color_codes)
      assert_equal(record.color_coding_complete?, false)

      #testing again with 1 review, 2 needed 
      first_review = record.add_review(1)
      first_review.mark_complete
      assert_equal(record.has_enough_reviews?, false)

      second_opinions = record.get_opinions
      opinion_values = second_opinions.values
      opinion_values["ShortName"] = true
      second_opinions.update_values(opinion_values)
      assert_equal(record.no_second_opinions?, false)
    end

    it "accepts complete reviews" do
      record = Record.find_by id: 1

      color_codes = record.color_codes
      color_codes.each do |key, value|
        color_codes[key] = "yellow"
      end
      record.get_colors.update_values(color_codes)
      assert_equal(record.color_coding_complete?, true)


      first_review = record.add_review(1)
      first_review.mark_complete
      second_review = record.add_review(2)
      second_review.mark_complete
      assert_equal(record.has_enough_reviews?, true)



      second_opinions = record.get_opinions
      opinion_values = second_opinions.values
      opinion_values["ShortName"] = false
      second_opinions.update_values(opinion_values)
      assert_equal(record.no_second_opinions?, true)
    end
  end

  describe "close" do
    it "closes a record" do
      record = Record.find_by id: 1
      record.close

      assert_equal(record.closed, true)
      #testing that the time is not null and within range
      assert_equal((record.closed_date && (record.closed_date < DateTime.now) && (record.closed_date > (DateTime.now - 5000))), true)
      record.closed_date = "Tue, 28 Feb 2017 16:25:04 UTC +00:00"
      record.save
      record.reload
      assert_equal(record.formatted_closed_date, "02/28/2017 at 11:25AM")
    end
  end

  describe "evaluate_script" do
    it "returns results of the automated collection_script" do
      record = Record.find_by id: 1
      raw_data = {"ShortName"=>"CDDIS_DORIS_products_orbit", "VersionId"=>"1", "InsertTime"=>"2007-09-12T17:00:00", "LastUpdate"=>"2012-06-14T00:00:00", "LongName"=>"Doppler Orbitography by Radiopositioning Integrated on Satellite Orbits Product from NASA CDDIS", "DataSetId"=>"CDDIS_DORIS_products_orbit", "Description"=>"Precise satellite orbits derived from analysis of Doppler Orbitography by Radiopositioning Integrated on Satellite (DORIS) data. These products are the generated by analysis centers in support of the International DORIS Service (IDS).", "Orderable"=>"1", "Visible"=>"1", "ProcessingLevelId"=>"2", "ArchiveCenter"=>"CDDIS", "Temporal"=>{"EndsAtPresentFlag"=>"true", "RangeDateTime"=>{"BeginningDateTime"=>"1992-11-04T00:00:00"}}, "Contacts"=>{"Contact"=>{"Role"=>"Archiver", "OrganizationName"=>"Crustal Dynamics Data Information System", "OrganizationAddresses"=>{"Address"=>{"StreetAddress"=>"NASA Goddard Space Flight Center, Code 690", "City"=>"Greenbelt", "StateProvince"=>"MD", "PostalCode"=>"20771", "Country"=>"USA"}}, "OrganizationPhones"=>{"Phone"=>[{"Number"=>"301-614-6542", "Type"=>"Telephone"}, {"Number"=>"301-614-6015", "Type"=>"Fax"}]}, "OrganizationEmails"=>{"Email"=>"Carey.E.Noll@nasa.gov"}, "ContactPersons"=>{"ContactPerson"=>{"FirstName"=>"Carey", "LastName"=>"Noll"}}}}, "Campaigns"=>{"Campaign"=>{"ShortName"=>"IDS", "LongName"=>"International DORIS Service"}}, "OnlineAccessURLs"=>{"OnlineAccessURL"=>{"URL"=>"ftp://cddis.gsfc.nasa.gov/doris/products/orbits"}}, "AssociatedDIFs"=>{"DIF"=>{"EntryId"=>"CDDIS_DORIS_data"}}, "Spatial"=>{"HorizontalSpatialDomain"=>{"Geometry"=>{"CoordinateSystem"=>"CARTESIAN", "BoundingRectangle"=>{"WestBoundingCoordinate"=>"-180.0", "NorthBoundingCoordinate"=>"90.0", "EastBoundingCoordinate"=>"180.0", "SouthBoundingCoordinate"=>"-90.0"}}}, "VerticalSpatialDomain"=>{"Type"=>"None", "Value"=>"None"}, "GranuleSpatialRepresentation"=>"CARTESIAN"}}
      comment_hash = record.evaluate_script(raw_data)

      assert_equal(comment_hash.to_s, "{\"Contacts/Contact/Role\"=>\"Choose a contact role from the following list: ARCHIVER; DISTRIBUTOR; ORIGINATOR; PROCESSOR;\", \"CitationForExternalPublication\"=>\"np\", \"Campaigns/Campaign/ShortName\"=>\"OK\", \"OnlineResources/OnlineResource/Type\"=>\"np\", \"ScienceKeywords/ScienceKeyword/CategoryKeyword\"=>\"Provide at least one science category keyword for this dataset. This is a required field.\", \"Campaigns/Campaign/EndDate\"=>\"np\", \"OnlineAccessURLs/OnlineAccessURL/URL\"=>\"OK\", \"Orderable\"=>\"Note: The Orderable field is being deprecated in UMM.\", \"Platforms/Platform/Instruments/Instrument/ShortName\"=>\"OK\", \"RevisionDate\"=>\"np\", \"OnlineAccessURLs/OnlineAccessURL/Description\"=>\"Recommend providing descriptions for all Online Access URLs.\", \"Platforms/Platform/Type\"=>\"Provide at least one platform for this dataset. This is a required field.\", \"Description\"=>\"OK - quality check\", \"ScienceKeywords/ScienceKeyword/TermKeyword\"=>\"Provide at least one science term keyword for this dataset. This is a required field.\", \"Campaigns/Campaign/LongName\"=>\"The campaign long name does not conform to GCMD\", \"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle\"=>\"OK - quality check, OK - quality check, OK - quality check, OK - quality check, \", \"Platforms/Platform/ShortName\"=>\"OK\", \"OnlineResources/OnlineResource/URL\"=>\"np\", \"LongName\"=>\"OK\", \"OnlineResources/OnlineResource/Description\"=>\"np\", \"Platforms/Platform/Instruments/Instrument/LongName\"=>\"Recommend providing an instrument long name; since many instrument long names are comprised of acronyms.\", \"ScienceKeywords/ScienceKeyword/VariableLevel1Keyword/Value\"=>\"np\", \"ProcessingCenter\"=>\"np\", \"Temporal/SingleDateTime\"=>\"np\", \"ScienceKeywords/ScienceKeyword/TopicKeyword\"=>\"Provide at least one science topic keyword for this dataset. This is a required field.\", \"SpatialKeywords/Keyword\"=>\"Recommend providing a spatial keyword from the following keywords list: http://gcmdservices.gsfc.nasa.gov/static/kms/locations/locations.csv\", \"Temporal/SingleDateTime/BeginningDateTime\"=>\"Beginning date time error\", \"InsertTime\"=>\"Insert time error\", \"Contacts/Contact/OrganizationEmails/Email\"=>\"OK\", \"ArchiveCenter\"=>\"It is recommended that the Archive Center name be compliant with GCMD vocabulary. Choose a valid Archive Center name from the following list: http://gcmdservices.gsfc.nasa.gov/static/kms/providers/providers.csv All records from the same DAAC should have the same archive center name for consistency.\", \"Temporal/RangeDateTime/EndingDateTime\"=>\"np\", \"DataSetId\"=>\"OK\", \"LastUpdate\"=>\"Last update time error\", \"Campaigns/Campaign/StartDate\"=>\"np\", \"CollectionState\"=>\"np\", \"Platforms/Platform/LongName\"=>\"OK\", \"ProcessingLevelId\"=>\"OK\", \"ScienceKeywords/ScienceKeyword/VariableLevel1Keyword/VariableLevel2Keyword/Value\"=>\"np\", \"ScienceKeywords/ScienceKeyword/VariableLevel1Keyword/VariableLevel2Keyword/VariableLevel3Keyword/Value\"=>\"np\", \"Visible\"=>\"Note: The Visible field is being deprecated in UMM.\", \"VersionId\"=>\"OK\", \"DataFormat\"=>\"Recommend providing the data format(s) for this dataset.\", \"ShortName\"=>\"OK\", \"OnlineResources/OnlineResource0/Type\"=>\"np\", \"OnlineResources/OnlineResource1/Type\"=>\"np\", \"OnlineResources/OnlineResource2/Type\"=>\"np\", \"OnlineResources/OnlineResource3/Type\"=>\"np\", \"OnlineResources/OnlineResource4/Type\"=>\"np\", \"OnlineResources/OnlineResource5/Type\"=>\"np\", \"OnlineResources/OnlineResource6/Type\"=>\"np\", \"ScienceKeywords/ScienceKeyword0/CategoryKeyword\"=>\"Provide at least one science category keyword for this dataset. This is a required field.\", \"ScienceKeywords/ScienceKeyword1/CategoryKeyword\"=>\"Provide at least one science category keyword for this dataset. This is a required field.\", \"OnlineAccessURLs/OnlineAccessURL/URLDescription\"=>\"OK - quality check\", \"AdditionalAttributes/AdditionalAttribute0/Description\"=>\"OK - quality check\", \"AdditionalAttributes/AdditionalAttribute1/Description\"=>\"OK - quality check\", \"OnlineResources/OnlineResource0/Description\"=>\"np\", \"OnlineResources/OnlineResource1/Description\"=>\"np\", \"OnlineResources/OnlineResource2/Description\"=>\"np\", \"OnlineResources/OnlineResource3/Description\"=>\"np\", \"OnlineResources/OnlineResource4/Description\"=>\"np\", \"OnlineResources/OnlineResource5/Description\"=>\"np\", \"OnlineResources/OnlineResource6/Description\"=>\"np\", \"ScienceKeywords/ScienceKeyword0/TermKeyword\"=>\"Provide at least one science term keyword for this dataset. This is a required field.\", \"ScienceKeywords/ScienceKeyword1/TermKeyword\"=>\"Provide at least one science term keyword for this dataset. This is a required field.\", \"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/WestBoundingCoordinate\"=>\"OK - quality check, OK - quality check, OK - quality check, OK - quality check, \", \"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/NorthBoundingCoordinate\"=>\"OK - quality check, OK - quality check, OK - quality check, OK - quality check, \", \"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/EastBoundingCoordinate\"=>\"OK - quality check, OK - quality check, OK - quality check, OK - quality check, \", \"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle/SouthBoundingCoordinate\"=>\"OK - quality check, OK - quality check, OK - quality check, OK - quality check, \", \"OnlineResources/OnlineResource0/URL\"=>\"np\", \"OnlineResources/OnlineResource1/URL\"=>\"np\", \"OnlineResources/OnlineResource2/URL\"=>\"np\", \"OnlineResources/OnlineResource3/URL\"=>\"np\", \"OnlineResources/OnlineResource4/URL\"=>\"np\", \"OnlineResources/OnlineResource5/URL\"=>\"np\", \"OnlineResources/OnlineResource6/URL\"=>\"np\", \"ScienceKeywords/ScienceKeyword0/VariableLevel1Keyword/Value\"=>\"np\", \"ScienceKeywords/ScienceKeyword1/VariableLevel1Keyword/Value\"=>\"np\", \"ScienceKeywords/ScienceKeyword0/TopicKeyword\"=>\"Provide at least one science topic keyword for this dataset. This is a required field.\", \"ScienceKeywords/ScienceKeyword1/TopicKeyword\"=>\"Provide at least one science topic keyword for this dataset. This is a required field.\", \"Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName\"=>\"OK\"}")
    end

    it "returns results of the automated granule_script" do
      #manually setting the record as a granule so the evaluate script runs the write python script
      record = Record.find_by id: 5
      raw_data = {"Granule"=>{"GranuleUR"=>"doris_campdata_saacorrection_ja1_ja1data355.saa.Z","InsertTime"=>"2012-11-08T13:15:00","LastUpdate"=>"2012-11-08T13:15:00","Collection"=>{"ShortName"=>"CDDIS_DORIS_data_cycle","VersionId"=>"1"},"DataGranule"=>{"SizeMBDataGranule"=>"3150.2294921875","ProducerGranuleId"=>"doris_campdata_saacorrection_ja1_ja1data355.saa.Z","DayNightFlag"=>"BOTH","ProductionDateTime"=>"2012-11-08T13:15:00"},"Temporal"=>{"RangeDateTime"=>{"BeginningDateTime"=>"2010-12-26T00:00:00","EndingDateTime"=>"2011-01-05T23:59:00"}},"Spatial"=>{"HorizontalSpatialDomain"=>{"Geometry"=>{"BoundingRectangle"=>{"WestBoundingCoordinate"=>"-180.0","NorthBoundingCoordinate"=>"90.0","EastBoundingCoordinate"=>"180.0","SouthBoundingCoordinate"=>"-90.0"}}}},"MeasuredParameters"=>{"MeasuredParameter"=>{"ParameterName"=>"DORIS Satellite Range-Rate Observation Data"}},"OnlineAccessURLs"=>{"OnlineAccessURL"=>{"URL"=>"ftp://cddis.gsfc.nasa.gov/pub/doris/campdata/saacorrection/ja1/ja1data355.saa.Z"}},"Orderable"=>"true","DataFormat"=>"DORIS"}}
      comment_hash = record.evaluate_script(raw_data)

      assert_equal(comment_hash.to_s, "{\"OrbitCalculatedSpatialDomains/OrbitCalculatedSpatialDomain/EquatorCrossingDateTime\"=>\"np\", \"Collection/DataSetId\"=>\"np\", \"Campaigns/Campaign/ShortName\"=>\"np\", \"OnlineAccessURLs/OnlineAccessURL/URLDescription\"=>\"Recommend providing a brief URL description\", \"Temporal/RangeDateTime/BeginningDateTime\"=>\"np\", \"OnlineResources/OnlineResource/Type\"=>\"np\", \"Temporal/RangeDateTime/SingleDateTime\"=>\"np\", \"OnlineAccessURLs/OnlineAccessURL/URL\"=>\"No Online Access URL is provided\", \"Orderable\"=>\"np\", \"OnlineResources/OnlineResource/Description\"=>\"Recommend providing descriptions for all Online Resource URLs.\", \"Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle\"=>\"np, np, np, np\", \"OnlineResources/OnlineResource/URL\"=>\"np\", \"DataGranule/SizeMBDataGranule\"=>\"Granule file size not provided. Recommend providing a value for this field in the metadata\", \"DeleteTime\"=>\"np\", \"Platforms/Platform\"=>\"np\", \"Platforms/Platform/ShortName\"=>\"np\", \"DataFormat\"=>\"Recommend providing the data format for the associated granule\", \"InsertTime\"=>\"np\", \"Temporal/RangeDateTime/EndingDateTime\"=>\"np\", \"LastUpdate\"=>\"np\", \"DataGranule/ProductionDateTime\"=>\"np\", \"Visible\"=>\"np\"}")
    end


  end
end